name: éƒ¨ç½² Svelte 5 + Vite é¡¹ç›®åˆ° GitHub Pages

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯ æˆ– æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main ]  # è‹¥é»˜è®¤åˆ†æ”¯æ˜¯ masterï¼Œæ”¹ä¸º [ master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

# éƒ¨ç½²å¿…è¦æƒé™ï¼ˆå›ºå®šé…ç½®ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}  # éƒ¨ç½²åè‡ªåŠ¨è¾“å‡ºè®¿é—®é“¾æ¥

    steps:
      ###########################################################################
      # æ­¥éª¤ 1ï¼šæ‹‰å–ä»“åº“ä»£ç ï¼ˆå«å­æ¨¡å—ï¼Œè‹¥æœ‰ï¼‰
      ###########################################################################
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼ˆé¿å…æ„å»ºæ—¶ä¾èµ–å†å²ä¿¡æ¯æŠ¥é”™ï¼‰

      ###########################################################################
      # æ­¥éª¤ 2ï¼šé…ç½® Node.js ç¯å¢ƒï¼ˆåŒ¹é…ä½ çš„é¡¹ç›®ä¾èµ–ï¼‰
      ###########################################################################
      - name: å®‰è£… Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20  # ä¸æ—¥å¿—ä¸­ç¼“å­˜çš„ 20.19.5 å…¼å®¹
          cache: 'npm'      # ç¼“å­˜ npm ä¾èµ–ï¼ŒåŠ é€ŸäºŒæ¬¡æ„å»º
          cache-dependency-path: package-lock.json  # ç²¾å‡†ç¼“å­˜ä¾èµ–æ–‡ä»¶

      ###########################################################################
      # æ­¥éª¤ 3ï¼šå®‰è£…ä¾èµ– + æ„å»ºé¡¹ç›®ï¼ˆå«è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é”™è¯¯ï¼‰
      ###########################################################################
      - name: å®‰è£…ä¾èµ–å¹¶æ„å»ºé¡¹ç›®
        run: |
          echo "===== æ¸…ç† npm ç¼“å­˜ ====="
          npm cache clean --force  # é¿å…ç¼“å­˜å¯¼è‡´çš„ä¾èµ–å®‰è£…å¤±è´¥
          
          echo "===== å®‰è£…é¡¹ç›®ä¾èµ– ====="
          npm install --verbose  # è¾“å‡ºè¯¦ç»†å®‰è£…æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ä¾¿äºå®šä½ï¼‰
          
          echo "===== æ‰§è¡Œç±»å‹æ£€æŸ¥ ====="
          npm run check  # è¿è¡Œ svelte-check + ts æ£€æŸ¥ï¼ˆæå‰å‘ç°è¯­æ³•é”™è¯¯ï¼‰
          
          echo "===== æ„å»ºé¡¹ç›® ====="
          npm run build --verbose  # è¾“å‡ºè¯¦ç»†æ„å»ºæ—¥å¿—
          
          echo "===== æ„å»ºå®Œæˆï¼ŒéªŒè¯ dist ç›®å½• ====="
          ls -la dist  # åˆ—å‡º dist ç›®å½•å†…å®¹ï¼ˆç¡®è®¤ index.html ç­‰æ–‡ä»¶å­˜åœ¨ï¼‰
          echo "dist ç›®å½•å¤§å°ï¼š$(du -sh dist | awk '{print $1}')"  # æŸ¥çœ‹æ„å»ºäº§ç‰©å¤§å°

      ###########################################################################
      # æ­¥éª¤ 4ï¼šé…ç½® SPA è·¯ç”±å…¼å®¹ï¼ˆè§£å†³ svelte-navigator åˆ·æ–° 404ï¼‰
      ###########################################################################
      - name: é…ç½®è·¯ç”± fallbackï¼ˆindex.html â†’ 404.htmlï¼‰
        run: |
          cd dist
          cp index.html 404.html  # æ ¸å¿ƒï¼šè®©æ‰€æœ‰è·¯ç”± fallback åˆ°ä¸»é¡µ
          echo "===== è·¯ç”±é…ç½®å®Œæˆ ====="
          ls -la dist | grep -E "index.html|404.html"  # éªŒè¯æ–‡ä»¶æ˜¯å¦å¤åˆ¶æˆåŠŸ

      ###########################################################################
      # æ­¥éª¤ 5ï¼šéƒ¨ç½²åˆ° GitHub Pagesï¼ˆç¨³å®šå¯é çš„å®˜æ–¹éƒ¨ç½²å·¥å…·ï¼‰
      ###########################################################################
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          folder: dist  # éƒ¨ç½² dist ç›®å½•ï¼ˆä¸ Vite æ„å»ºè¾“å‡ºä¸€è‡´ï¼‰
          clean: true  # éƒ¨ç½²å‰æ¸…ç† gh-pages åˆ†æ”¯æ—§æ–‡ä»¶ï¼ˆé¿å…å†—ä½™ï¼‰

      ###########################################################################
      # æ­¥éª¤ 6ï¼šè¾“å‡ºéƒ¨ç½²ç»“æœï¼ˆå¯é€‰ï¼Œä¾¿äºå¿«é€ŸæŸ¥çœ‹è®¿é—®é“¾æ¥ï¼‰
      ###########################################################################
      - name: è¾“å‡ºéƒ¨ç½²æˆåŠŸä¿¡æ¯
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“¦ éƒ¨ç½²ç›®å½•ï¼šdist"
          echo "ğŸŒ è®¿é—®é“¾æ¥ï¼š${{ steps.deployment.outputs.page_url }}"
