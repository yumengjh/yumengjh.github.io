name: 部署 Svelte + Vite 项目到 GitHub Pages

# 触发条件：推送到 main 分支（或 master，根据你的默认分支修改）
on:
  push:
    branches: [ main ]  # 若默认分支是 master，改为 branches: [ master ]
  workflow_dispatch:  # 允许手动触发部署

# 权限配置：必须开启，否则无法写入 gh-pages 分支
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1. 拉取仓库代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 配置 Node.js 环境（匹配项目依赖的 Node 版本，推荐 18+）
      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20  # 与你本地开发环境一致即可
          cache: 'npm'      # 缓存 npm 依赖，加速构建

      # 3. 安装依赖 + 构建项目（使用 Vite 构建，输出到 dist 目录）
      - name: 安装依赖并构建
        run: |
          npm install  # 安装所有依赖（包括 overrides 中的 rolldown-vite）
          npm run build  # 执行 Vite 构建，输出到 dist 目录

      # 4. 关键：处理 svelte-navigator 路由兼容（解决刷新 404）
      # 原理：GitHub Pages 不支持 SPA 路由，将所有路由 fallback 到 index.html
      - name: 配置 SPA 路由 fallback
        run: |
          cd dist  # 进入 Vite 构建输出目录（你的项目是 dist，不是 build）
          cp index.html 404.html  # 复制 index.html 为 404.html，实现路由 fallback

      # 5. 部署到 GitHub Pages（指定 dist 目录为部署源）
      - name: 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          folder: dist  # 核心配置：部署 dist 目录下的静态文件
